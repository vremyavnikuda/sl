
# Документация функции play_mp3

## Назначение
Функция `play_mp3` предназначена для воспроизведения MP3-файла с использованием библиотеки **mpg123** для декодирования MP3 и библиотеки **libao** для вывода звука на устройство воспроизведения (например, колонки или наушники).

## Сигнатура функции
```cpp
void play_mp3(const std::string &file);
```

## Параметры
- **file** (`const std::string&`): Путь к MP3-файлу, который нужно воспроизвести.

## Внутренняя логика
1. **Инициализация библиотек:**
   - `ao_initialize()` — Инициализирует библиотеку **libao** для работы с аудиоустройствами.
   - `mpg123_init()` — Инициализирует библиотеку **mpg123** для декодирования MP3.

2. **Выбор аудиодрайвера:**
   - `ao_default_driver_id()` — Возвращает идентификатор аудиодрайвера по умолчанию, который будет использоваться для воспроизведения.

3. **Создание дескриптора mpg123:**
   - `mpg123_handle *mh = mpg123_new(nullptr, nullptr)` — Создается новый объект для работы с MP3-декодером.

4. **Открытие MP3-файла:**
   - `mpg123_open(mh, file.c_str())` — Открывает указанный MP3-файл для чтения. Если не удается открыть файл, выводится сообщение об ошибке и выполнение функции прекращается.

5. **Получение параметров аудиоформата:**
   - `mpg123_getformat(mh, &rate, &channels, &encoding)` — Извлекает информацию о частоте дискретизации, количестве каналов и кодировке из MP3-файла.

6. **Настройка аудиоформата для libao:**
   - Поля структуры `ao_sample_format` заполняются параметрами, полученными из MP3-файла:
     - `format.bits`: количество бит в одном семпле (определяется через `mpg123_encsize`).
     - `format.channels`: количество аудиоканалов (например, моно или стерео).
     - `format.rate`: частота дискретизации (например, 44100 Гц).
     - `format.byte_format`: формат байтов (нативный для платформы).

7. **Открытие аудиоустройства:**
   - `ao_open_live(driver, &format, nullptr)` — Открывает аудиоустройство для воспроизведения в реальном времени с заданными параметрами формата.

8. **Чтение и воспроизведение данных:**
   - В цикле:
     - `mpg123_read()` — Читает декодированные аудиоданные из MP3-файла в буфер.
     - `ao_play()` — Отправляет аудиоданные на устройство воспроизведения, если глобальная переменная `playing` установлена в `true`. Если `playing` установлена в `false`, происходит пауза на 100 миллисекунд.
     - Цикл продолжается, пока данные не будут полностью прочитаны из файла или пока не установлены глобальные флаги `stop_playing` или `exit_flag`.

9. **Очистка ресурсов:**
   - После завершения воспроизведения освобождаются ресурсы:
     - Освобождается буфер для аудиоданных.
     - Закрываются дескрипторы аудиоустройства и декодера MP3.
     - Деинициализируются библиотеки **mpg123** и **libao**.

## Управление воспроизведением
- **Пауза**: Если глобальная переменная `playing` установлена в `false`, воспроизведение приостанавливается, и программа засыпает на 100 мс.
- **Остановка**: Цикл воспроизведения прерывается, если установлены глобальные переменные `stop_playing` или `exit_flag`.

## Глобальные переменные
- **playing** (`std::atomic<bool>`): Если установлена в `true`, воспроизведение продолжается; если в `false` — воспроизведение приостанавливается.
- **stop_playing** (`std::atomic<bool>`): Флаг, который используется для завершения текущего трека и перехода к следующему.
- **exit_flag** (`std::atomic<bool>`): Флаг завершения воспроизведения, останавливающий весь процесс.

## Обработка ошибок
- Если MP3-файл не удается открыть или возникли проблемы с аудиоустройством, выводится сообщение об ошибке в `std::cerr`, и функция завершает работу.

## Пример вызова
```cpp
play_mp3("path/to/song.mp3");
```
Этот вызов начинает воспроизведение файла `song.mp3`, используя системные аудиоустройства.

## Важно
Перед вызовом этой функции необходимо инициализировать глобальные переменные (`playing`, `stop_playing`, `exit_flag`) для корректной работы управления воспроизведением.
